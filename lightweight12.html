<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <title>TradingView Chart â€“ Jalali Dates + Toggles + Short Lines</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #controls {
      padding: 10px 15px;
      background: #f2f2f2;
      border-bottom: 1px solid #ccc;
      direction: rtl;
    }
    #controls label { margin-left: 20px; cursor: pointer; user-select: none; }
    #chart { height: calc(100vh - 48px); }   /* leave room for toggle bar */
  </style>
</head>
<body>
  <!-- â”€â”€ toggle bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="controls"></div>

  <!-- â”€â”€ chart container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="chart"></div>

  <!-- â”€â”€ scripts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    fetch('ÙØ®Ø§Ø³.json')
      .then(r => r.json())
      .then(data => {
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ chart setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
          layout: {
            background: { color: '#ffffff' },
            textColor:   '#000',
            fontSize:    14          // ðŸ“ bigger text
          },
          rightPriceScale: { visible: true, borderVisible: true },
          timeScale: {
            borderVisible: true,
            rightOffset:   5,
            timeVisible:   true,
            secondsVisible:false,
            tickMarkFormatter: idx => dateMap[idx] || '',
          },
          grid: { vertLines: { visible: false }, horzLines: { visible: true } },
          crosshair: {
            mode: 0,
            vertLine:{ labelVisible:false },
            horzLine:{ labelVisible:true }
          },
        });

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ colors & helpers â”€â”€â”€â”€â”€â”€â”€ */
const colors = {
  // ðŸ”µ Primary indicators â€“ rich and clear
  'P/E':             '#1976D2',  // Rich Blue
  'Ø´Ø§Ø®Øµ Ú¯Ø±ÙˆÙ‡ P/E':   '#D32F2F',  // Bold Red
  'Ø´Ø§Ø®Øµ Ú©Ù„ P/E':     '#388E3C',  // Deep Green

  // âœ¨ Averages â€“ Gold/Bronze tones
  'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† P/E':     '#FFC107',  // Amber / Gold
  'Ú†Ù‡Ø§Ø± Ø³Ø§Ù„Ù‡ P/E':   '#FFB300',  // Deeper Gold
  'ÛŒÚ© Ø³Ø§Ù„Ù‡ P/E':     '#FFD54F',  // Light Gold / Champagne
};


        /* map numeric index => Jalali date text */
        const dateMap = {};
        data.forEach((d,i)=>{ dateMap[i+1]=d.time; });

        const seriesMap = {};

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ main visible lines â”€â”€â”€â”€â”€ */
        ['P/E','Ø´Ø§Ø®Øµ Ú¯Ø±ÙˆÙ‡ P/E','Ø´Ø§Ø®Øµ Ú©Ù„ P/E'].forEach(key=>{
          const s = chart.addLineSeries({
            color: colors[key], lineWidth:2,
            priceLineVisible:true, lastValueVisible:true, title:key
          });
          s.setData(data.map((d,i)=>({time:i+1, value:d[key]})));
          seriesMap[key]=s;
        });

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† P/E full-length (but NOT beyond data) â”€â”€ */
        {
          const key    = 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† P/E';
          const value  = data[data.length-1][key];

          const avgLine = chart.addLineSeries({
            color: colors[key], lineWidth:4,
            priceLineVisible:false,   // no full-width price-line
            lastValueVisible:true,    // keep axis label
            crossHairMarkerVisible:false
          });
          avgLine.setData([
            {time:1,            value:value},
            {time:data.length,  value:value}
          ]);
          /* title for legend / tooltip */
          avgLine.applyOptions({title:key});
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1-year & 4-year short segments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const segments = {
          'ÛŒÚ© Ø³Ø§Ù„Ù‡ P/E':   252,           // â‰ˆ trading days
          'Ú†Ù‡Ø§Ø± Ø³Ø§Ù„Ù‡ P/E': 252*4
        };

        ['ÛŒÚ© Ø³Ø§Ù„Ù‡ P/E','Ú†Ù‡Ø§Ø± Ø³Ø§Ù„Ù‡ P/E'].forEach(key=>{
          const color     = colors[key];
          const endIdx    = data.length;
          const startIdx  = Math.max(1, endIdx - segments[key]);
          const value     = data[endIdx-1][key];

          /* short visible segment */
          const seg = chart.addLineSeries({
            color: color, lineWidth:4,
            priceLineVisible:false, lastValueVisible:false,
            crossHairMarkerVisible:false
          });
          seg.setData([{time:startIdx, value:value},{time:endIdx, value:value}]);

          /* invisible point just to show axis label + legend */
          const labelSeries = chart.addLineSeries({
            color: color, lineWidth:0,
            priceLineVisible:true, lastValueVisible:true,
            crossHairMarkerVisible:false, title:key
          });
          labelSeries.setData([{time:endIdx, value:value}]);
        });

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ toggle check-boxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const controls = document.getElementById('controls');
        ['Ø´Ø§Ø®Øµ Ú©Ù„ P/E','Ø´Ø§Ø®Øµ Ú¯Ø±ÙˆÙ‡ P/E'].forEach(key=>{
          const lbl = document.createElement('label');
          const cb  = document.createElement('input');
          cb.type='checkbox'; cb.checked=true;
          cb.style.verticalAlign='middle';
          cb.addEventListener('change', e=>{
            seriesMap[key].applyOptions({visible:e.target.checked});
          });
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(' '+key));
          controls.appendChild(lbl);
        });
      })
      .catch(err=>{
        console.error(err);
        document.getElementById('chart').innerHTML=
          '<div style="padding:20px;color:red">Failed to load data.</div>';
      });
  </script>
</body>
</html>
